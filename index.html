<script>
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSE7fEFVv-U8Zu1egpFcgj28fSq5KOpaDPbLRCvYLpaM0ERCIvvTRAbXZ6-RzT0Q8SRF7MZoLDWU9y/pub?gid=0&single=true&output=csv";

  const agregarAfiliado = (url) => {
    if (!url) return "#";
    if (url.includes("/go?id=")) return url;
    if (!url.includes("amazon.")) return url;
    const tieneTag = url.includes("tag=");
    return tieneTag ? url : url + (url.includes("?") ? "&" : "?") + "tag=imadinho0c-21";
  };

  const cerrarPopup = () => {
    document.getElementById("popupOverlay").style.display = "none";
    document.getElementById("popup").style.display = "none";
  };

  const toggleFavorito = (url, el) => {
    let favoritos = JSON.parse(localStorage.getItem("favoritos") || "[]");
    if (favoritos.includes(url)) {
      favoritos = favoritos.filter(f => f !== url);
      el.classList.remove("favorite");
    } else {
      favoritos.push(url);
      el.classList.add("favorite");
    }
    localStorage.setItem("favoritos", JSON.stringify(favoritos));
    render(currentPage);
  };

  let ofertas = [];
  let currentPage = 1;
  const itemsPerPage = 20;

  const renderPagination = (totalPages) => {
    const paginador = document.getElementById("pagination");
    paginador.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.className = `px-3 py-1 rounded ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white'} mx-1`;
      btn.textContent = i;
      btn.onclick = () => {
        currentPage = i;
        render(currentPage);
      };
      paginador.appendChild(btn);
    }
  };

  const render = (page) => {
    const contenedor = document.getElementById("ofertas");
    contenedor.innerHTML = "";
    const favoritos = JSON.parse(localStorage.getItem("favoritos") || "[]");

    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageItems = ofertas.slice(start, end);

    pageItems.forEach((o, i) => {
      const img = o.imagen && o.imagen.startsWith("http") ? o.imagen : "https://via.placeholder.com/300x200.png?text=Sin+imagen";
      const card = document.createElement("div");
      card.className = "bg-white dark:bg-gray-800 rounded-lg shadow p-3 hover:shadow-xl transition text-sm flex flex-col justify-between relative";
      const isFav = favoritos.includes(o.enlace);
      card.innerHTML = `
        <button class="absolute top-2 right-2 text-xl ${isFav ? 'favorite' : ''}" onclick="toggleFavorito('${o.enlace}', this)">â˜…</button>
        <div class="mb-2 h-28 flex items-center justify-center overflow-hidden rounded bg-gray-200 dark:bg-gray-700">
          <img src="${img}" alt="Imagen de la oferta" class="object-contain h-full w-full">
        </div>
        <h2 class="text-sm font-bold text-gray-800 dark:text-gray-100 mb-1 line-clamp-2">${o.titulo}</h2>
        <div class="text-xs text-gray-600 dark:text-gray-300 flex-grow max-h-20 overflow-y-auto">${o.descripcion}</div>
        <p class="text-xs text-gray-400 dark:text-gray-500 mt-2 mb-1 italic">ðŸ“… ${o.fecha || ""}</p>
        <a href="${agregarAfiliado(o.enlace)}" target="_blank" class="inline-block text-center bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition text-xs font-medium">ðŸ›’ Ver oferta</a>
      `;
      contenedor.appendChild(card);
    });
    renderPagination(Math.ceil(ofertas.length / itemsPerPage));
  };

  const mostrarPopup = (oferta) => {
    const popup = document.getElementById("popup");
    popup.querySelector("a").href = agregarAfiliado(oferta.enlace);
    document.getElementById("popupOverlay").style.display = "block";
    popup.style.display = "block";
  };

  fetch(SHEET_URL)
    .then((res) => res.text())
    .then((data) => {
      const rows = data.trim().split("\n").slice(1);
      ofertas = rows.map(row => {
        const cols = row.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(c => c.replace(/^\"|\"$/g, "").trim());
        const [titulo, enlace, descripcion = "", fecha = "", imagen = ""] = cols;
        return { titulo, enlace, descripcion, fecha, imagen };
      }).filter(o => o.titulo && o.enlace).reverse();

      currentPage = 1;
      render(currentPage);
      mostrarPopup(ofertas[0]);
    })
    .catch((err) => {
      document.getElementById("ofertas").innerHTML = "<p class='text-red-500'>No se pudieron cargar las ofertas.</p>";
      console.error("Error cargando CSV:", err);
    });
</script>

<!-- Popup HTML actualizado -->
<div class="popup-overlay" id="popupOverlay"></div>
<div class="popup" id="popup">
  <h2 class="text-lg font-bold mb-2">ðŸŽ¯ Oferta destacada</h2>
  <p class="mb-4">No te pierdas este chollo exclusivo que acabamos de encontrar.</p>
  <a href="#" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mb-2 w-full text-center">ðŸ”¥ Ir a la oferta</a>
  <button onclick="cerrarPopup()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded w-full">Cerrar</button>
</div>

<!-- Paginador -->
<div class="flex justify-center mt-6" id="pagination"></div>
